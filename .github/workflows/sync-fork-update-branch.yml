name: sync-fork-update-branch

on:
  schedule:
    # 每12小时检查一次，可根据需要调整
    - cron: '0 */12 * * *'
  workflow_dispatch: # 支持手动触发

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        source_repo:
          - Acode-Foundation/Acode
          - Xed-Editor/Xed-Editor
          - bggRGjQaUbCoE/PiliPlus
          - wgtunnel/wgtunnel
          - fantasytyx/bv
          - cat3399/blbl
          - T8RIN/ImageToolbox
          - rainxchzed/Github-Store
          - MuntashirAkon/AppManager
    steps:
    - name: Checkout ci repository
      uses: actions/checkout@main

    - name: Setup git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
    
    - name: Sync ${{ matrix.source_repo }}
      env:
        SOURCE_REPO: ${{ matrix.source_repo }}
        # 注意：此处假设Fork仓库名与源仓库名相同。如果不相同，请手动指定。
        FORK_REPO: zxgv5/${{ matrix.source_repo.split('/')[1] }}
        # 使用个人访问令牌，需要有推送权限
        GH_TOKEN: ${{ secrets.SYNC_FORK_TOKEN }}
      run: |
        echo "正在同步仓库：$SOURCE_REPO -> $FORK_REPO"
        # 1. 使用 --bare 克隆Fork仓库（关键修改）
        git clone --bare "https://${GH_TOKEN}@github.com/${FORK_REPO}.git" sync-repo
        cd sync-repo
        
        # 2. 添加源仓库为上游远程
        git remote add upstream "https://github.com/${SOURCE_REPO}.git"
        
        # 3. 获取上游所有分支和标签
        echo "获取上游仓库更新..."
        git fetch upstream --prune --tags
        
        # 4. 获取上游的所有分支列表
        branches=$(git for-each-ref --format='%(refname:lstrip=3)' refs/remotes/upstream/)
        
        # 5. 遍历每个分支进行检查和同步
        for branch in $branches; do
          echo "检查分支: $branch"
          # 检查上游分支与Fork分支是否有差异
          if ! git diff --quiet upstream/$branch origin/$branch 2>/dev/null; then
            echo "分支 $branch 有更新，正在同步..."
            # 关键修改：将上游分支内容抓取到本地，然后推送到Fork
            git fetch upstream $branch:$branch
            git push origin $branch
          else
            echo "分支 $branch 已是最新。"
          fi
        done
        
        # 6. 同步所有标签
        echo "同步标签..."
        git push origin --tags --force
        
        # 7. 清理
        cd ..
        rm -rf sync-repo
        echo "同步完成！"