name: sync-fork-update-branch

on:
  schedule:
    # 每12小时检查一次
    - cron: '0 */12 * * *'
  workflow_dispatch: # 支持手动触发

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 定义源仓库与你的Fork仓库的映射关系
        # 请将‘fork’字段修改为你实际创建的Fork仓库全名
        repo_pair:
          - source: Acode-Foundation/Acode
            fork: zxgv5/a-Acode
          - source: Xed-Editor/Xed-Editor
            fork: zxgv5/a-Xed-Editor
          - source: bggRGjQaUbCoE/PiliPlus
            fork: zxgv5/a-PiliPlus
          - source: wgtunnel/wgtunnel
            fork: zxgv5/a-wgtunnel
          - source: fantasytyx/bv
            fork: zxgv5/a-fantasy-bv
          - source: cat3399/blbl
            fork: zxgv5/a-blbl
          - source: T8RIN/ImageToolbox
            fork: zxgv5/a-ImageToolbox
          - source: rainxchzed/Github-Store
            fork: zxgv5/a-Github-Store
          - source: MuntashirAkon/AppManager
            fork: zxgv5/a-AppManager

    steps:
      - name: Checkout ci repository
        uses: actions/checkout@main

      - name: Setup git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Sync ${{ matrix.repo_pair.source }} to ${{ matrix.repo_pair.fork }}
        env:
          SOURCE_REPO: ${{ matrix.repo_pair.source }}
          FORK_REPO: ${{ matrix.repo_pair.fork }}
          GH_TOKEN: ${{ secrets.SYNC_FORK_TOKEN }}
        run: |
          echo "=========================================="
          echo "开始同步：上游 [$SOURCE_REPO] -> 镜像 [$FORK_REPO]"
          echo "=========================================="
          # 1. 裸克隆Fork镜像仓库
          echo "步骤1：克隆镜像仓库..."
          git clone --bare "https://${GH_TOKEN}@github.com/${FORK_REPO}.git" sync-repo
          cd sync-repo
          # 2. 添加上游源仓库
          echo "步骤2：添加上游源仓库..."
          git remote add upstream "https://github.com/${SOURCE_REPO}.git"
          # 3. 获取上游所有更新（分支和标签）
          echo "步骤3：获取上游仓库所有分支和标签..."
          git fetch upstream --prune --tags
          # 4. 获取上游分支列表
          echo "步骤4：分析分支..."
          upstream_branches=$(git for-each-ref --format='%(refname:lstrip=3)' refs/remotes/upstream/)
          echo "找到上游分支：$(echo $upstream_branches | tr '\n' ' ')"
          # 5. 遍历并同步每个分支
          for branch in $upstream_branches; do
            echo "--- 检查分支 [$branch] ---"
            # 检查是否存在差异
            if ! git diff --quiet upstream/$branch origin/$branch 2>/dev/null; then
              echo "  检测到更新，正在同步..."
              # 将上游分支抓取到本地临时分支，然后推送
              git fetch upstream $branch:$branch
              git push origin $branch
              echo "  分支 [$branch] 同步完成。"
            else
              echo "  已是最新，无需同步。"
            fi
          done
          # 6. 同步所有标签（强制覆盖）
          echo "步骤5：同步标签..."
          git push origin --tags --force
          # 7. 清理工作目录
          echo "步骤6：清理..."
          cd ..
          rm -rf sync-repo
          echo "=========================================="
          echo "仓库 [$SOURCE_REPO] 同步完成！"
          echo "=========================================="