name: build-apk-readest

on:
  workflow_dispatch:
  workflow_call:

env:
  JDK_VERSION: '17'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  NDK_VERSION: '28.2.13676358'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/daemon/
          rm -rf ~/.android/build-cache/
          rm -rf .gradle

      - name: Checkout source repo
        uses: actions/checkout@main
        with:
          repository: readest/readest
          ref: main
          path: readest_source
          fetch-depth: 0
          submodules: recursive

      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV

      - name: Setup java
        uses: actions/setup-java@main
        with:
          java-version: "${{ env.JDK_VERSION }}"
          distribution: "temurin"

      # 手动安装 Android SDK 和 NDK，并统一环境变量
      - name: Manual install android sdk and ndk
        run: |
          export ANDROID_HOME=$HOME/android-sdk
          export NDK_VERSION="${{ env.NDK_VERSION }}"
          mkdir -p ${ANDROID_HOME}
          cd ${ANDROID_HOME}
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11391160_latest.zip
          unzip -q commandlinetools-linux-*.zip
          rm commandlinetools-linux-*.zip
          mkdir -p latest
          mv cmdline-tools/* latest/
          mv latest cmdline-tools/
          export PATH=${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${PATH}
          echo "ANDROID_HOME=${ANDROID_HOME}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=${ANDROID_HOME}" >> $GITHUB_ENV
          echo "${ANDROID_HOME}/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "${ANDROID_HOME}/platform-tools" >> $GITHUB_PATH
          yes | sdkmanager --licenses > /dev/null 2>&1 || true
          sdkmanager "platform-tools" \
                     "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
                     "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
                     "ndk;${NDK_VERSION}"
          echo "NDK_HOME=${ANDROID_HOME}/ndk/${NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Setup node.js
        uses: actions/setup-node@main
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@master
        with:
          version: 10

      - name: Setup rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: aarch64-linux-android

      - name: Rust cache
        uses: Swatinem/rust-cache@master
        with:
          key: android-arm64-cargo
          working-directory: readest_source

      - name: Install pnpm dependencies
        working-directory: ./readest_source
        run: pnpm install

      - name: Copy vendor assets
        working-directory: ./readest_source
        run: pnpm --filter @readest/readest-app setup-vendors

      - name: Decode keystore
        working-directory: ./readest_source
        run: |
          mkdir -p apps/readest-app/src-tauri/gen/android
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ./keystore.p12

      - name: Create .env.local for next.js
        working-directory: ./readest_source/apps/readest-app
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_POSTHOG_KEY=${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST=${{ secrets.NEXT_PUBLIC_POSTHOG_HOST }}
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_PLATFORM=tauri
          EOF

      - name: Prepare android project and signing config
        working-directory: ./readest_source/apps/readest-app
        env:
          ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          rm -rf src-tauri/gen/android
          pnpm tauri android init
          if [ $? -ne 0 ]; then
            echo "❌ tauri android init failed"
            exit 1
          fi
          ANDROID_PROJECT_DIR="src-tauri/gen/android"
          # 修正 sdk.dir
          if [ -f "${ANDROID_PROJECT_DIR}/local.properties" ]; then
            sed -i "s|^sdk.dir=.*|sdk.dir=${ANDROID_HOME}|" "${ANDROID_PROJECT_DIR}/local.properties"
          else
            echo "sdk.dir=${ANDROID_HOME}" > "${ANDROID_PROJECT_DIR}/local.properties"
          fi
          # 写入 keystore.properties
          pushd ${ANDROID_PROJECT_DIR}
          cat > keystore.properties << EOF
          keyAlias=${ env.ANDROID_KEY_ALIAS }
          keyPassword=${ env.ANDROID_KEY_PASSWORD }
          storeFile=${{ github.workspace }}/readest_source/keystore.p12
          storePassword=${ env.ANDROID_KEY_PASSWORD }
          EOF
          echo "keystore.properties content:"
          cat keystore.properties
          popd
          pnpm tauri icon ../../data/icons/readest-book.png || true

      # 诊断签名配置
      - name: Check signing config
        working-directory: ./readest_source/apps/readest-app/src-tauri/gen/android
        run: |
          chmod +x gradlew
          echo "=== Signing report for universalRelease ==="
          ./gradlew signingReport | grep -A20 "Variant: universalRelease" || true

      - name: Build android arm64 apk
        working-directory: ./readest_source/apps/readest-app
        env:
          NDK_HOME: ${{ env.NDK_HOME }}
          ANDROID_NDK_HOME: ${{ env.NDK_HOME }}
        run: |
          pnpm tauri android build -t aarch64 --verbose

      - name: Find and rename apk artifact
        working-directory: ./readest_source
        run: |
          mkdir -p ${{ github.workspace }}/dist
          # 优先选择已签名的 APK（不含 -unsigned）
          APK_PATH=$(find apps/readest-app/src-tauri/gen/android -path "*/release/*.apk" -type f ! -name "*-unsigned.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "No signed APK found, using unsigned APK (will fail verification)."
            APK_PATH=$(find apps/readest-app/src-tauri/gen/android -path "*/release/*.apk" -type f | head -n 1)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "❌ No APK found!"
            exit 1
          fi
          echo "Found APK: $APK_PATH"
          cp "$APK_PATH" ${{ github.workspace }}/dist/readest-${{ env.BUILD_DATE }}.apk

      # 验证 APK 签名
      - name: Verify apk signature
        run: |
          APKSIGNER="$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}/apksigner"
          if [ ! -f "$APKSIGNER" ]; then
            echo "apksigner not found, trying system path..."
            APKSIGNER="apksigner"
          fi
          if $APKSIGNER verify ${{ github.workspace }}/dist/readest-${{ env.BUILD_DATE }}.apk; then
            echo "✅ APK is signed."
          else
            echo "❌ APK is not signed! Build failed."
            exit 1
          fi

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          P12_KEYSTORE_PATH: "./readest_source/keystore.p12"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./dist/readest-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-readest"