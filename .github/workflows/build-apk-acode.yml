name: build-apk-acode

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

env:
  # 签名配置使用环境变量，不在代码中硬编码密码
  KEYSTORE_PATH: "./android/app/paid-release.keystore"
  # F-Droid模式明确禁用，确保targetSdkVersion=35
  F_DROID_MODE: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@main
        with:
          repository: Acode-Foundation/Acode
          ref: main
          path: acode_source
          fetch-depth: 0

      - name: Checkout ci repository
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Setup build environment
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +'%y%m%d-%H%M%S')" >> $GITHUB_ENV
          echo "SHORT_SHA=$(cd acode_source && git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "PREV_TAG=$(cd acode_source && git describe --tags --abbrev=0 2>/dev/null || echo 'initial')" >> $GITHUB_ENV

      - name: Setup java and android sdk
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '17' # Cordova Android 14要求JDK 17

      - name: Setup bun runtime
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Setup fdroid configuration
        working-directory: ./acode_source
        run: |
          # 明确设置F-Droid模式为false，确保targetSdkVersion=35
          echo "${{ env.F_DROID_MODE }}" > /tmp/fdroid.bool
          echo "F-Droid模式已设置为: ${{ env.F_DROID_MODE }} (targetSdkVersion=35)"

      - name: Restore signing credentials
        working-directory: ./acode_source
        run: |
          # 关键修复：创建android/app目录
          mkdir -p android/app
          
          # 从Secrets还原签名密钥文件
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "${{ env.KEYSTORE_PATH }}"
          
          echo "✅ 签名密钥文件已恢复"
          echo "密钥文件路径: $(pwd)/${{ env.KEYSTORE_PATH }}"
          ls -la android/app/
          
          # 验证密钥文件有效性
          keytool -list -keystore "${{ env.KEYSTORE_PATH }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" -v && echo "✅ 密钥验证成功"

      - name: Inject build configuration
        working-directory: ./acode_source
        run: |
          # 从config.xml提取版本信息
          APP_VERSION=$(grep -oP 'version="\K[0-9.]+' config.xml)
          VERSION_CODE=$(grep -oP 'android-versionCode="\K[0-9]+' config.xml)
          
          # 在版本号后追加提交哈希
          UPDATED_VERSION="${APP_VERSION}-${SHORT_SHA}"
          echo "构建版本: $UPDATED_VERSION (原始: $APP_VERSION)"
          echo "版本代码: $VERSION_CODE"
          
          # 更新config.xml中的版本号
          sed -i "s/version=\"$APP_VERSION\"/version=\"$UPDATED_VERSION\"/" config.xml
          
          # 设置环境变量供后续步骤使用
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "UPDATED_VERSION=$UPDATED_VERSION" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV

      - name: Generate build configuration
        working-directory: ./acode_source
        run: |
          # 1. 生成build.json（使用环境变量，确保密码正确注入）
          cat > build.json << EOF
          {
            "android": {
              "release": {
                "keystore": "./android/app/paid-release.keystore",
                "storePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
                "alias": "${{ secrets.KEY_ALIAS }}",
                "password": "${{ secrets.KEY_PASSWORD }}"
              }
            }
          }
          EOF
          
          echo "✅ build.json已生成"
          echo "build.json内容预览:"
          cat build.json | sed 's/"storePassword": ".*"/"storePassword": "***"/g' | sed 's/"password": ".*"/"password": "***"/g'
          
          # 验证build.json格式
          if jq empty build.json 2>/dev/null; then
            echo "✅ build.json格式正确"
          else
            echo "❌ build.json格式错误"
            exit 1
          fi
          
          # 2. 生成config.js（简化为仅处理付费版生产构建）
          cat > utils/config.js << 'EOF'
          // 简化的config.js，仅处理付费版生产构建
          const path = require("node:path");
          const fs = require("node:fs");
          
          // 读取配置
          const configPath = path.resolve(__dirname, "../config.xml");
          let config = fs.readFileSync(configPath, "utf-8");
          
          // 确保是付费版ID
          if (!config.includes('id="com.foxdebug.acode"')) {
            config = config.replace(/id="[^"]+"/, 'id="com.foxdebug.acode"');
            fs.writeFileSync(configPath, config, "utf8");
            console.log("✅ 已设置为付费版应用ID");
          }
          
          // 设置生产模式（compact）
          const babelrcPath = path.resolve(__dirname, "../.babelrc");
          const babelrc = JSON.parse(fs.readFileSync(babelrcPath, "utf-8"));
          babelrc.compact = true;
          fs.writeFileSync(babelrcPath, JSON.stringify(babelrc, null, 2), "utf8");
          
          console.log("✅ 配置完成");
          EOF
          
          echo "✅ config.js已生成"
          
          # 验证config.js语法
          if node -c utils/config.js; then
            echo "✅ config.js语法正确"
          else
            echo "❌ config.js语法错误"
            exit 1
          fi

      - name: Install project dependencies
        working-directory: ./acode_source
        run: |
          # 使用Bun安装依赖，利用其更快的速度
          bun install
          # 安装钩子脚本所需的全局依赖
          bun add -g prettier prettier-plugin-java

      - name: Install cordova cli
        working-directory: ./acode_source
        run: |
          # 安装与package.json中版本匹配的Cordova
          CORDOVA_VERSION=$(grep -oP '"cordova": "\K[^"]+' package.json)
          echo "检测到Cordova版本: ${CORDOVA_VERSION}"
          bun add cordova@${CORDOVA_VERSION}
          echo "✅ Cordova CLI ${CORDOVA_VERSION} 已安装"

      - name: Execute application build
        working-directory: ./acode_source
        run: |
          # 调用项目自身的构建脚本，确保与本地构建一致
          echo "开始构建 Paid Release APK..."
          sh ./utils/scripts/build.sh paid p apk
          
          # 验证构建产物
          if [ -f "platforms/android/app/build/outputs/apk/release/app-release.apk" ]; then
            echo "✅ APK构建成功!"
            cp platforms/android/app/build/outputs/apk/release/app-release.apk "/tmp/acode-${{ env.BUILD_DATE }}.apk"
            ls -lh "/tmp/acode-${{ env.BUILD_DATE }}.apk"
          else
            echo "❌ 错误: 未找到构建产物!"
            find platforms/android/app/build/outputs -name "*.apk" -type f
            exit 1
          fi

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          P12_KEYSTORE_PATH: "build.json ${{ env.KEYSTORE_PATH }}"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "/tmp/acode-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "build-${{ env.BUILD_DATE }}"