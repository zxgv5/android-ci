name: build-apk-koreader

on:
  workflow_dispatch:

env:
  JDK_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_NDK_VERSION: '26.1.10909125'
  ANDROID_ARCH: arm64
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/daemon/
          rm -rf ~/.android/build-cache/
          rm -rf .gradle
          rm -rf ~/.ccache # 清掉旧缓存，防止NDK不匹配残留

      - name: Checkout koreader source
        uses: actions/checkout@main
        with:
          repository: koreader/koreader
          ref: master
          path: koreader_source
          fetch-depth: 0
          submodules: recursive

      - name: Checkout ci repository
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Set build date
        run: echo "BUILD_DATE=$(TZ=UTC-8 date +'%y.%m.%d-%H.%M.%S')" >> $GITHUB_ENV

      - name: Set up java
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      - name: Set up android sdk & ndk
        uses: android-actions/setup-android@main
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          accept-licenses: true

      # 强制用NDK 26.1，覆盖系统自带的27
      - name: Force use ndk 26.1
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION" >> $GITHUB_ENV
          echo "PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make wget unzip ccache ninja-build python3-pip
          pip3 install meson

      - name: Setup ccache
        uses: actions/cache@main
        with:
          path: ~/.ccache
          key: android-ccache-${{ github.sha }}
          restore-keys: |
            android-ccache-

      - name: Fetch 3rd party submodules
        working-directory: ./koreader_source
        run: make fetchthirdparty

      - name: Build koreader apk
        working-directory: ./koreader_source
        run: |
          export ANDROID_ARCH=${{ env.ANDROID_ARCH }}
          make TARGET=android update

      - name: Locate and rename apk
        working-directory: ./koreader_source
        run: |
          mkdir -p dist
          APK_FILE=$(find . -name "koreader-android-*.apk" -type f | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "APK not found!"
            exit 1
          fi
          mv "$APK_FILE" "${{ github.workspace }}/dist/koreader-unsigned.apk"

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12

      - name: Sign apk
        run: |
          export PATH="$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}:$PATH"
          apksigner sign \
            --ks keystore.p12 \
            --ks-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-type PKCS12 \
            --out "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk" \
            "${{ github.workspace }}/dist/koreader-unsigned.apk"
          apksigner verify --verbose "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk"
