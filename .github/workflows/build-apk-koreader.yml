name: build-apk-koreader

on:
  workflow_dispatch:

env:
  JDK_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  ANDROID_NDK_VERSION: '25.2.9519653'   # NDK r25c
  ANDROID_ARCH: arm64
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/daemon/
          rm -rf ~/.android/build-cache/
          rm -rf .gradle
          rm -rf ~/.ccache

      - name: Checkout koreader source
        uses: actions/checkout@main
        with:
          repository: koreader/koreader
          ref: master
          path: koreader_source
          fetch-depth: 0
          submodules: recursive

      - name: Checkout ci repository (self)
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Set build date
        run: echo "BUILD_DATE=$(TZ=UTC-8 date +'%y.%m.%d-%H.%M.%S')" >> $GITHUB_ENV

      - name: Setup java
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      # 手动安装 Android SDK & NDK，确保指定版本
      - name: Setup android sdk & ndk
        run: |
          export ANDROID_HOME=$HOME/android-sdk
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses > /dev/null
          sdkmanager "platform-tools" \
                     "platforms;android-$ANDROID_COMPILE_SDK" \
                     "build-tools;$ANDROID_BUILD_TOOLS" \
                     "ndk;$ANDROID_NDK_VERSION"
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/$ANDROID_NDK_VERSION" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      - name: Verify ndk version
        run: |
          echo "NDK version:"
          $ANDROID_NDK_HOME/ndk-build --version || true
          which clang || true
          clang --version | head -1

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make wget unzip ccache ninja-build python3-pip
          pip3 install meson

      - name: Setup ccache
        uses: actions/cache@main
        with:
          path: ~/.ccache
          key: android-ccache-${{ github.sha }}
          restore-keys: |
            android-ccache-

      - name: Fetch third-party submodules
        working-directory: ./koreader_source
        run: make fetchthirdparty

      # 清理之前可能的构建残留
      - name: Clean base build directory
        working-directory: ./koreader_source
        run: make clean || true

      - name: Check disk space
        run: df -h

      - name: Build koreader apk (serial)
        working-directory: ./koreader_source
        run: |
          export ANDROID_ARCH=${{ env.ANDROID_ARCH }}
          make -j1 TARGET=android update
        timeout-minutes: 120

      - name: Debug - list build artifacts on failure
        if: failure()
        working-directory: ./koreader_source
        run: |
          echo "=== Build failed, collecting logs ==="
          find base/build -name "CMakeOutput.log" -o -name "CMakeError.log" | while read f; do
            echo "--- $f ---"
            cat "$f"
          done
          find base/build -name "*.log" | while read f; do
            echo "--- $f (tail) ---"
            tail -n 50 "$f"
          done
          exit 1

      - name: Locate and rename apk
        working-directory: ./koreader_source
        run: |
          mkdir -p dist
          APK_FILE=$(find . -name "koreader-android-*.apk" -type f | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "APK not found! Check build logs."
            exit 1
          fi
          mv "$APK_FILE" "${{ github.workspace }}/dist/koreader-unsigned.apk"

      - name: Decode keystore.p12
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12

      - name: Sign apk (pkcs12)
        run: |
          export PATH="$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}:$PATH"
          apksigner sign \
            --ks keystore.p12 \
            --ks-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-type PKCS12 \
            --out "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk" \
            "${{ github.workspace }}/dist/koreader-unsigned.apk"
          apksigner verify --verbose "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk"