name: sync-fork-xqqv5

on:
  schedule:
    - cron: '0 0 1 * *' # 每月1号触发
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 定义源仓库与Fork仓库的映射关系
        repo_pair:
          - source: linbox-team/fflas-ffpack
            fork: xqqv5/fflas-ffpack
          - source: komrad36/BitOps
            fork: xqqv5/BitOps
          - source: komrad36/Factorization-Primality
            fork: xqqv5/Factorization-Primality
          - source: massgravel/Microsoft-Activation-Scripts
            fork: xqqv5/Microsoft-Activation-Scripts
          - source: 9001/copyparty
            fork: xqqv5/copyparty
          - source: veeso/termscp
            fork: xqqv5/termscp
          - source: Keidan/HexViewer
            fork: xqqv5/HexViewer
          - source: julian-klode/dns66
            fork: xqqv5/dns66
          - source: flintlib/flint
            fork: xqqv5/flint
          - source: open-webui/open-webui
            fork: xqqv5/open-webui
          - source: flutter/flutter
            fork: xqqv5/flutter
          - source: sumatrapdfreader/sumatrapdf
            fork: xqqv5/sumatrapdf
          - source: google/skia
            fork: xqqv5/skia
          - source: microsoft/terminal
            fork: xqqv5/terminal
          - source: MatrixSeven/file-transfer-go
            fork: xqqv5/file-transfer-go
          - source: xixu-me/xget
            fork: xqqv5/Xget
          - source: xixu-me/xget-now
            fork: xqqv5/Xget-Now
          - source: notepad-plus-plus/notepad-plus-plus
            fork: xqqv5/notepad-plus-plus
          - source: PowerShell/PowerShell
            fork: xqqv5/PowerShell
          - source: simdjson/simdjson
            fork: xqqv5/simdjson
          - source: fastfloat/fast_float
            fork: xqqv5/fast_float_int_etc
          - source: massivemadness/Squircle-CE
            fork: xqqv5/Squircle-CE
          - source: ImranR98/Obtainium
            fork: xqqv5/Obtainium
          - source: sky22333/hubproxy
            fork: xqqv5/hubproxy
          - source: gildas-lormeau/SingleFile
            fork: xqqv5/SingleFile
          - source: lyswhut/lx-music-desktop
            fork: xqqv5/lx-music-desktop
          - source: lyswhut/lx-music-mobile
            fork: xqqv5/lx-music-mobile
          - source: veracrypt/VeraCrypt
            fork: xqqv5/VeraCrypt
          - source: Cyan4973/xxHash
            fork: xqqv5/xxHash
          - source: freedomofpress/dangerzone
            fork: xqqv5/dangerzone
          - source: WerWolv/ImHex
            fork: xqqv5/ImHex
          - source: NationalSecurityAgency/ghidra
            fork: xqqv5/ghidra
          - source: ventoy/Ventoy
            fork: xqqv5/Ventoy
          - source: WinMerge/winmerge
            fork: xqqv5/winmerge
          - source: Delphier/DxAutoInstaller
            fork: xqqv5/DxAutoInstaller
          - source: microsoft/PowerToys
            fork: xqqv5/PowerToys
          - source: localsend/localsend
            fork: xqqv5/localsend
          - source: drakkan/sftpgo
            fork: xqqv5/sftp-go
          - source: tfonteyn/Sshd4a
            fork: xqqv5/Sshd4a
          - source: amnezia-vpn/amnezia-client
            fork: xqqv5/amnezia-client
          - source: openssl/openssl
            fork: xqqv5/openssl
          - source: alireza-md93/GPU-Accelerated-Viterbi-Decoder
            fork: xqqv5/GPU-Accelerated-Viterbi-Decoder
          - source: malb/m4ri
            fork: xqqv5/m4ri
          - source: malb/m4rie
            fork: xqqv5/m4rie
          - source: wolfSSL/wolfssl
            fork: xqqv5/wolfssl
          - source: alam00000/bentopdf
            fork: xqqv5/bentopdf
          - source: androidx/media
            fork: xqqv5/media

    steps:
      - name: Checkout ci repository
        uses: actions/checkout@main

      - name: Setup git and gh
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          # 安装 GitHub CLI 用于查询仓库默认分支
          type -p gh >/dev/null || sudo apt-get install -y gh

      - name: Sync ${{ matrix.repo_pair.source }} - default branch
        env:
          SOURCE_REPO: ${{ matrix.repo_pair.source }}
          FORK_REPO: ${{ matrix.repo_pair.fork }}
          GH_TOKEN: ${{ secrets.SYNC_FORK_TOKEN_NO_01_AT_XQQV5 }}
        run: |
          # 1. 使用 git ls-remote 获取源仓库的默认分支名
          echo "步骤1：获取源仓库默认分支..."
          # 查询上游仓库的HEAD引用，它指向默认分支
          DEFAULT_BRANCH_INFO=$(git ls-remote --symref "https://github.com/${SOURCE_REPO}.git" HEAD)
          # 从输出中提取分支名（例如：ref: refs/heads/main  HEAD）
          DEFAULT_BRANCH=$(echo "$DEFAULT_BRANCH_INFO" | awk '/^ref:/ {sub(/refs\/heads\//, "", $2); print $2; exit}')
          if [ -z "$DEFAULT_BRANCH" ]; then
            # 备用方案：如果上述方法失败，尝试另一种解析方式
            DEFAULT_BRANCH=$(echo "$DEFAULT_BRANCH_INFO" | grep -o 'refs/heads/[^ 	]*' | head -1 | sed 's|refs/heads/||')
          fi
          echo "默认分支为: $DEFAULT_BRANCH"
          # 2. 克隆 Fork 仓库（浅克隆，指定默认分支）
          echo "步骤2：克隆镜像仓库..."
          # 先尝试克隆指定分支，如果分支不存在则退出
          git clone --depth=1 --branch="$DEFAULT_BRANCH" "https://${GH_TOKEN}@github.com/${FORK_REPO}.git" sync-repo
          cd sync-repo
          # 3. 添加上游源仓库并拉取默认分支更新
          echo "步骤3：拉取上游更新..."
          git remote add upstream "https://github.com/${SOURCE_REPO}.git"
          git fetch upstream "$DEFAULT_BRANCH"
          # 4. 检查是否有新提交
          echo "步骤4：检查差异..."
          # 比较上游拉取的内容与本地分支
          if git diff --quiet FETCH_HEAD "$DEFAULT_BRANCH"; then
            echo "默认分支 [$DEFAULT_BRANCH] 已是最新，无需同步。"
          else
            echo "检测到更新，正在同步..."
            # 5. 合并上游更新（快速转发）并推送
            git merge --ff-only FETCH_HEAD
            git push origin "$DEFAULT_BRANCH"
            echo "默认分支 [$DEFAULT_BRANCH] 同步完成。"
          fi
          # 6. 清理
          echo "步骤5：清理..."
          cd ..
          rm -rf sync-repo
