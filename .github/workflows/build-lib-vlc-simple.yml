name: build-lib-vlc-simple

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch of vlc-android repo to build from'
        required: true
        default: 'libvlc-3.6.5'
        type: string
      release_tag:
        description: 'Tag name for the GitHub Release'
        required: true
        default: 'libvlc-build'
        type: string

env:
  SOURCE_REPO: 'https://github.com/videolan/vlc-android.git'
  BUILD_DIR: 'vlc-android-source'
  GRADLE_VERSION: '8.13'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CI repository
        uses: actions/checkout@v4

      - name: Clone source repository
        run: |
          echo "ğŸ“¥ Cloning source repo: ${{ env.SOURCE_REPO }}"
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.BUILD_DIR }}"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK and NDK
        id: android-setup  # ç»™æ­¥éª¤ä¸€ä¸ªIDï¼Œä¾¿äºåç»­å¼•ç”¨
        uses: android-actions/setup-android@v3
        # æ­¤ Action ä¼šè‡ªåŠ¨è®¾ç½® ANDROID_SDK_ROOT, ANDROID_HOME, ANDROID_NDK_ROOT ç­‰å˜é‡

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            automake autopoint cmake build-essential libtool \
            patch pkg-config ragel subversion unzip git \
            flex python3 wget ninja-build meson nasm yasm \
            libssl-dev

      - name: Configure project environment
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ”§ é…ç½®æ„å»ºç¯å¢ƒ..."
          
          # å…³é”®ä¿®å¤ 1ï¼šæ˜¾å¼è®¾ç½® compile.sh æ‰€éœ€çš„ç¯å¢ƒå˜é‡
          # ä» android-actions è®¾ç½®çš„ç¯å¢ƒä¸­è·å–è·¯å¾„ï¼Œå¹¶å¯¼å‡ºä¸ºè„šæœ¬è¦æ±‚çš„å˜é‡å
          echo "ANDROID_SDK used by compile.sh is set to: $ANDROID_SDK_ROOT"
          echo "ANDROID_NDK used by compile.sh is set to: $ANDROID_NDK_ROOT"
          
          # åˆ›å»º local.properties (Gradleä½¿ç”¨)
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK_ROOT" >> local.properties
          echo "âœ… Created local.properties"
          
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Gradle ç‰ˆæœ¬
          WRAPPER_PROPERTIES="gradle/wrapper/gradle-wrapper.properties"
          if [ -f "$WRAPPER_PROPERTIES" ]; then
            sed -i.bak "s|distributionUrl=.*|distributionUrl=https\\\\://services.gradle.org/distributions/gradle-${{ env.GRADLE_VERSION }}-all.zip|" "$WRAPPER_PROPERTIES"
          fi
          chmod +x buildsystem/compile.sh || true

      # ä¸ºæ¯ä¸ªæ¶æ„æ„å»ºï¼Œå¹¶ç¡®ä¿åœ¨æ„å»ºæ­¥éª¤ä¸­å¯¼å‡ºç¯å¢ƒå˜é‡
      - name: Build for ARM64 (arm64-v8a)
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ—ï¸  å¼€å§‹ ARM64 æ¶æ„çš„ RELEASE æ„å»º..."
          echo "=== ç¯å¢ƒéªŒè¯ ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          
          # å…³é”®ä¿®å¤ 2ï¼šåœ¨è°ƒç”¨ç¼–è¯‘è„šæœ¬å‰ï¼Œç¡®ä¿å¯¼å‡ºè„šæœ¬è¦æ±‚çš„å…·ä½“å˜é‡å
          # è®¸å¤šä¼ ç»Ÿè„šæœ¬æœŸæœ›ä½¿ç”¨ ANDROID_SDK å’Œ ANDROID_NDKï¼ˆæ—  _ROOT åç¼€ï¼‰
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          echo "å¯¼å‡ºä¾› compile.sh ä½¿ç”¨çš„å˜é‡:"
          echo "ANDROID_SDK=$ANDROID_SDK"
          echo "ANDROID_NDK=$ANDROID_NDK"
          echo "================="
          
          # æ‰§è¡Œæ„å»º
          ./buildsystem/compile.sh -l -a arm64 --release
          echo "âœ… ARM64 æ„å»ºå®Œæˆã€‚"

      - name: Build for ARMv7 (armeabi-v7a)
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»ºè¾“å‡º..."
          rm -f libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
          
          echo "ğŸ—ï¸  å¼€å§‹ ARMv7 æ¶æ„çš„ RELEASE æ„å»º..."
          # å…³é”®ä¿®å¤ 3ï¼šåŒæ ·ä¸º ARMv7 æ„å»ºå¯¼å‡ºç¯å¢ƒå˜é‡
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          ./buildsystem/compile.sh -l -a arm --release
          echo "âœ… ARMv7 æ„å»ºå®Œæˆã€‚"

      - name: Prepare build artifacts
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ“¦ å‡†å¤‡æ„å»ºäº§ç‰©..."
          AAR_DIR="libvlcjni/libvlc/build/outputs/aar"
          if [ -d "$AAR_DIR" ]; then
            # å¤åˆ¶æ‰€æœ‰AARæ–‡ä»¶åˆ°å·¥ä½œåŒºæ ¹ç›®å½•
            find "$AAR_DIR" -name "*.aar" -exec cp {} ../ \;
          fi
          cd ..
          echo "å½“å‰ç›®å½•çš„AARæ–‡ä»¶:"
          ls -la *.aar 2>/dev/null || echo "âš ï¸  æœªæ‰¾åˆ°AARæ–‡ä»¶ã€‚"

      - name: Merge multi-ABI AAR
        run: |
          echo "ğŸ”€ åˆå¹¶å¤šæ¶æ„ AAR æ–‡ä»¶..."
          # åˆå¹¶è„šæœ¬
          /bin/bash -c '
          set -e
          shopt -s nullglob
          aar_files=(*.aar)
          if [ ${#aar_files[@]} -eq 0 ]; then
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•AARæ–‡ä»¶ç”¨äºåˆå¹¶ã€‚"
              exit 1
          fi
          echo "æ‰¾åˆ°çš„AARæ–‡ä»¶: ${aar_files[@]}"
          BASE_AAR="${aar_files[0]}"
          echo "ä»¥ $BASE_AAR ä½œä¸ºåŸºç¡€åŒ…"
          mkdir -p merged-aar
          unzip -q "$BASE_AAR" -d merged-aar
          for aar in "${aar_files[@]:1}"; do
              echo "åˆå¹¶: $aar"
              mkdir -p temp-merge
              unzip -q "$aar" -d temp-merge
              if [ -d "temp-merge/jni" ]; then
                  cp -rf temp-merge/jni/. merged-aar/jni/ 2>/dev/null || true
              fi
              rm -rf temp-merge
          done
          cd merged-aar
          zip -qr ../libvlc-release.aar .
          cd ..
          echo "âœ… åˆå¹¶å®Œæˆï¼Œç”Ÿæˆ libvlc-release.aar"
          echo "ğŸ“Š åˆå¹¶åŒ…å†…å®¹æ¦‚è§ˆ (JNIéƒ¨åˆ†):"
          unzip -l libvlc-release.aar | grep "jni/" || echo "æœªæ‰¾åˆ°jniç›®å½•ã€‚"
          '
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libvlc-build-output
          path: |
            libvlc-release.aar
          retention-days: 7

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ github.event.inputs.release_tag }}-$(date +'%Y%m%d-%H%M%S')
          name: "LibVLC AAR - ${{ github.event.inputs.source_branch }}"
          body: |
            Automated build of LibVLC for Android.
            - **Source Branch:** ${{ github.event.inputs.source_branch }}
            - **Build Date:** $(date -u)
            - **Commit:** $(cd ${{ env.BUILD_DIR }} && git log -1 --oneline)
            - **Contains:** ARM64-v8a & ARMEABI-v7a
          files: libvlc-release.aar
          draft: false
          prerelease: false