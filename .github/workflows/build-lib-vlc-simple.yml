name: build-lib-vlc-simple

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch from videolan/vlc-android'
        required: true
        default: 'libvlc-3.6.5'
        type: string

# 1. å¯ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
env:
  SOURCE_REPO: 'https://github.com/videolan/vlc-android.git'
  BUILD_DIR: 'vlc-android-source'
  GRADLE_VERSION: '8.13'

jobs:
  build:
    runs-on: ubuntu-latest
    # 2. è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾… (è¿™é‡Œè®¾ä¸º4å°æ—¶)
    timeout-minutes: 240

    steps:
      - name: Checkout CI repository
        uses: actions/checkout@v4

      # 3. å°è¯•æ¢å¤Gradleå’ŒNDKæ„å»ºç¼“å­˜ï¼Œå¤§å¹…æé€Ÿ
      - name: Cache Gradle and NDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ env.BUILD_DIR }}/vlc/contrib-* # VLC è´¡çŒ®åº“çš„ç¼–è¯‘ç¼“å­˜
          key: ${{ runner.os }}-gradle-ndk-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-ndk-

      - name: Clone source repository
        run: |
          echo "Cloning source repository..."
          # ä½¿ç”¨æ›´å½»åº•çš„æ¸…ç†ï¼Œé¿å…æ®‹ç•™æ–‡ä»¶å¯¼è‡´é—®é¢˜
          rm -rf "${{ env.BUILD_DIR }}"
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.BUILD_DIR }}"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK and NDK
        uses: android-actions/setup-android@v3
        with:
          # æ˜ç¡®æŒ‡å®šä¸€ä¸ªä¸VLC 3.xå…¼å®¹çš„NDKç‰ˆæœ¬ï¼Œé¿å…æœ€æ–°ç‰ˆä¸å…¼å®¹
          ndk-version: '25.2.9519653'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            automake autopoint cmake build-essential libtool \
            patch pkg-config ragel subversion unzip git \
            flex python3 python3-pip wget ninja-build meson nasm yasm \
            libssl-dev protobuf-compiler gettext

      - name: Configure project and environment
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "é…ç½®æ„å»ºç¯å¢ƒ..."
          
          # è®¾ç½®compile.shè„šæœ¬æ‰€éœ€çš„ç¯å¢ƒå˜é‡ (å…³é”®ä¿®å¤)
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          # ä¸ºgradleåˆ›å»ºé…ç½®æ–‡ä»¶
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK_ROOT" >> local.properties
          
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Gradleç‰ˆæœ¬
          ./gradlew wrapper --gradle-version=${{ env.GRADLE_VERSION }} --distribution-type=all || echo "Gradle wrapperåˆå§‹åŒ–å®Œæˆã€‚"
          
          # éªŒè¯ç¯å¢ƒ
          echo "=== ç¯å¢ƒéªŒè¯ ==="
          echo "JAVA_HOME: $JAVA_HOME"
          echo "ANDROID_SDK: $ANDROID_SDK"
          echo "ANDROID_NDK: $ANDROID_NDK"
          echo "================="

      - name: Configure project and environment
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== é…ç½®æ„å»ºç¯å¢ƒ ==="
          
          # 1. é¦–è¦ï¼šé…ç½® Git èº«ä»½ï¼Œè§£å†³ `git am` é”™è¯¯
          echo "è®¾ç½® Git èº«ä»½ç”¨äºåº”ç”¨è¡¥ä¸..."
          git config --global user.email "build@github-actions"
          git config --global user.name "GitHub Actions Bot"
          echo "âœ… Git èº«ä»½å·²è®¾ç½®"

          # 2. è®¾ç½®ç¼–è¯‘è„šæœ¬æ‰€éœ€çš„ç¯å¢ƒå˜é‡
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          echo "ç¯å¢ƒå˜é‡å·²å¯¼å‡º:"
          echo "  ANDROID_SDK = $ANDROID_SDK"
          echo "  ANDROID_NDK = $ANDROID_NDK"

          # 3. ä¸º Gradle åˆ›å»ºé…ç½®æ–‡ä»¶
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK_ROOT" >> local.properties
          echo "âœ… local.properties å·²åˆ›å»º"

          # 4. ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Gradle ç‰ˆæœ¬
          echo "åˆå§‹åŒ– Gradle Wrapper (ç‰ˆæœ¬: ${{ env.GRADLE_VERSION }})..."
          # é™é»˜æ‰§è¡Œï¼Œå¿½ç•¥å·²å­˜åœ¨çš„è­¦å‘Š
          ./gradlew wrapper --gradle-version=${{ env.GRADLE_VERSION }} --distribution-type=all --quiet 2>/dev/null || true
    
          # 5. ç»™æ„å»ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x buildsystem/compile.sh 2>/dev/null || true
          echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"

      # 4. åˆ†ç¦»ä¸¤ä¸ªæ¶æ„çš„æ„å»ºï¼Œå¹¶æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†
      - name: Build LibVLC for ARM64
        timeout-minutes: 180 # ä¸ºå•ä¸ªæ¶æ„æ„å»ºè®¾ç½®ç‹¬ç«‹è¶…æ—¶
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "å¼€å§‹æ„å»º ARM64 (arm64-v8a) æ¶æ„..."
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡ï¼Œç¡®ä¿å¯¹å­shellç”Ÿæ•ˆ
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          # æ‰§è¡Œæ„å»ºï¼Œå¹¶å°†è¯¦ç»†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ä»¥ä¾¿è°ƒè¯•
          # ä½¿ç”¨ `time` å‘½ä»¤è®°å½•æ„å»ºè€—æ—¶
          time ./buildsystem/compile.sh -l -a arm64 --release 2>&1 | tee build_arm64.log
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -f "libvlcjni/libvlc/build/outputs/aar/"*.aar ]; then
            echo "âœ… ARM64 AAR æ„å»ºæˆåŠŸï¼"
            cp libvlcjni/libvlc/build/outputs/aar/*.aar ../libvlc-arm64.aar
          else
            echo "âš ï¸  æœªæ‰¾åˆ°ARM64 AARæ–‡ä»¶ï¼Œæ„å»ºå¯èƒ½æœªç”Ÿæˆé¢„æœŸè¾“å‡ºã€‚"
            echo "æ„å»ºæ—¥å¿—å°¾éƒ¨:"
            tail -50 build_arm64.log
          fi

      - name: Build LibVLC for ARMv7
        timeout-minutes: 180
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "æ¸…ç†å‰ä¸€æ¬¡æ„å»ºçš„ä¸­é—´äº§ç‰©..."
          # åªæ¸…ç†AARè¾“å‡ºï¼Œä¿ç•™å·²ä¸‹è½½çš„æºç å’Œè´¡çŒ®åº“ä»¥åŠ é€Ÿç¬¬äºŒæ¬¡æ„å»º
          rm -rf libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
          
          echo "å¼€å§‹æ„å»º ARMv7 (armeabi-v7a) æ¶æ„..."
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          time ./buildsystem/compile.sh -l -a arm --release 2>&1 | tee build_armv7.log
          
          if [ -f "libvlcjni/libvlc/build/outputs/aar/"*.aar ]; then
            echo "âœ… ARMv7 AAR æ„å»ºæˆåŠŸï¼"
            cp libvlcjni/libvlc/build/outputs/aar/*.aar ../libvlc-armv7.aar
          else
            echo "âš ï¸  æœªæ‰¾åˆ°ARMv7 AARæ–‡ä»¶ã€‚"
            echo "æ„å»ºæ—¥å¿—å°¾éƒ¨:"
            tail -50 build_armv7.log
          fi

      # 5. åˆå¹¶AARå¹¶éªŒè¯
      - name: Merge AARs and verify
        if: always() # å³ä½¿ä¸Šä¸€æ­¥æœ‰è­¦å‘Šä¹Ÿç»§ç»­æ‰§è¡Œ
        run: |
          echo "å‡†å¤‡åˆå¹¶AARæ–‡ä»¶..."
          cd "${{ env.BUILD_DIR }}"
          
          # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½ç”Ÿæˆçš„AARæ–‡ä»¶
          find . -name "*.aar" -type f -exec cp {} ../ \;
          cd ..
          
          echo "æ‰¾åˆ°çš„AARæ–‡ä»¶ï¼š"
          ls -la *.aar 2>/dev/null || { echo "æœªæ‰¾åˆ°ä»»ä½•AARæ–‡ä»¶ï¼Œæ„å»ºå¯èƒ½å¤±è´¥ã€‚"; exit 1; }
          
          # æ™ºèƒ½åˆå¹¶ï¼šè‡ªåŠ¨è¯†åˆ«åŸºç¡€åŒ…å’Œæ¶æ„åŒ…
          /bin/bash -c '
          aars=(*.aar)
          if [ ${#aars[@]} -lt 1 ]; then
              exit 1
          fi
          # å°è¯•æ‰¾åˆ°ä¸€ä¸ªåŒ…å«â€œallâ€æˆ–ç‰ˆæœ¬å·æœ€å…¨çš„ä½œä¸ºåŸºç¡€åŒ…
          BASE_AAR=""
          for aar in "${aars[@]}"; do
              if [[ "$aar" == *"all"* ]] || [[ "$aar" == *"release"* ]]; then
                  BASE_AAR="$aar"
                  break
              fi
          done
          if [ -z "$BASE_AAR" ]; then
              BASE_AAR="${aars[0]}"
          fi
          
          echo "ä½¿ç”¨ $BASE_AAR ä½œä¸ºåŸºç¡€åŒ…è¿›è¡Œåˆå¹¶"
          mkdir -p merged-aar
          unzip -q "$BASE_AAR" -d merged-aar
          
          for aar in "${aars[@]}"; do
              if [ "$aar" != "$BASE_AAR" ]; then
                  echo "åˆå¹¶æ¶æ„åº“ä»: $aar"
                  unzip -q -u "$aar" -d merged-aar 2>/dev/null || true
              fi
          done
          
          cd merged-aar
          zip -qr ../libvlc-release.aar .
          cd ..
          
          echo "âœ… åˆå¹¶å®Œæˆï¼æœ€ç»ˆäº§ç‰©: libvlc-release.aar"
          echo "åŒ…å«çš„æ¶æ„:"
          unzip -l libvlc-release.aar | grep "jni/.*/" | cut -d"/" -f2 | sort -u || echo "æ— æ³•åˆ—å‡ºæ¶æ„"
          '

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libvlc-build-output-${{ github.run_id }}
          path: |
            libvlc-release.aar
            vlc-android-source/build_*.log
            *.aar
          retention-days: 30

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: libvlc-${{ github.event.inputs.source_branch }}-$(date +'%Y%m%d-%H%M%S')
          name: LibVLC AAR (${{ github.event.inputs.source_branch }}) - $(date +'%Y-%m-%d')
          body: |
            ğŸ—ï¸ è‡ªåŠ¨æ„å»ºçš„ LibVLC Android AAR åº“
            
            **æ„å»ºä¿¡æ¯**
            - æºåˆ†æ”¯: `${{ github.event.inputs.source_branch }}`
            - æ„å»ºæ—¶é—´: $(date -u "+%Y-%m-%d %H:%M:%S UTC")
            - è§¦å‘æäº¤: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - å·¥ä½œæµè¿è¡Œ: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            **ä½¿ç”¨è¯´æ˜**
            1. ä¸‹è½½ `libvlc-release.aar`
            2. æ”¾å…¥ä½  Android é¡¹ç›®çš„ `app/libs/` ç›®å½•
            3. åœ¨ `build.gradle` ä¸­æ·»åŠ :
            ```gradle
            dependencies {
                implementation files("libs/libvlc-release.aar")
            }
            ```
            
            **æ„å»ºæ—¥å¿—**
            è¯¦ç»†æ„å»ºæ—¥å¿—å¯åœ¨ Artifacts ä¸­ä¸‹è½½ã€‚
          files: libvlc-release.aar
          draft: false
          prerelease: false