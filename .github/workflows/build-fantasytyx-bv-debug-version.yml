name: build-fantasytyx-bv-debug-version

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '要构建的分支'
        required: false
        default: 'develop'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@main
      with:
        repository: xqqv5/fantasy-bv
        ref: ${{ github.event.inputs.branch || 'develop' }}
        token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Debug - Show project structure
      run: |
        echo "=== 项目结构调试 ==="
        echo "当前目录: $(pwd)"
        echo ""
        echo "所有文件:"
        ls -la
        echo ""
        echo "Gradle配置:"
        find . -name "*.gradle*" -type f | head -20
        echo ""
        echo "Gradle包装器:"
        ls -la gradlew* || echo "gradlew未找到"
        echo ""
        echo "Android项目检查:"
        find . -name "AndroidManifest.xml" | head -5
        echo ""
        echo "Gradle版本:"
        ./gradlew --version || echo "无法获取Gradle版本"
        
    - name: Set up JDK 21
      uses: actions/setup-java@main
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@main
      
    - name: Accept licenses and install packages
      run: |
        yes | sdkmanager --licenses
        sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        
    - name: Make gradlew executable
      run: |
        chmod +x gradlew
        
    - name: Generate keystore
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
        KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD || 'android' }}
      run: |
        keytool -genkeypair -v \
          -keystore keystore.jks \
          -alias "$KEY_ALIAS" \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass "$KEYSTORE_PASSWORD" \
          -keypass "$KEY_ALIAS_PASSWORD" \
          -dname "CN=Android, OU=Android, O=Unknown, L=Unknown, C=CN" \
          -noprompt
        
    - name: Create signing.properties
      run: |
        cat > signing.properties << EOF
              keystore.path=./keystore.jks
              keystore.pwd=${{ secrets.KEYSTORE_PASSWORD || 'android' }}
              keystore.alias=${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
              keystore.alias_pwd=${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD || 'android' }}
              EOF
        
    - name: Try to build with debug
      run: |
        echo "尝试构建debug版本..."
        ./gradlew clean assembleDebug --stacktrace --warning-mode=all 2>&1 | tee debug-build.log
        
        # 检查是否成功
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "✅ Debug构建成功"
          echo "查找APK文件:"
          find . -name "*.apk" -type f | xargs ls -lh
        else
          echo "❌ Debug构建失败"
          echo "最后100行日志:"
          tail -100 debug-build.log
        fi
        
    - name: Check build.gradle files
      run: |
        echo "=== 检查构建配置 ==="
        echo "检查项目级build.gradle:"
        if [ -f "build.gradle" ]; then
          head -50 build.gradle
        elif [ -f "build.gradle.kts" ]; then
          head -50 build.gradle.kts
        fi
        
        echo ""
        echo "检查应用级build.gradle:"
        if [ -f "app/build.gradle" ]; then
          echo "app/build.gradle内容:"
          head -100 app/build.gradle
        elif [ -f "app/build.gradle.kts" ]; then
          echo "app/build.gradle.kts内容:"
          head -100 app/build.gradle.kts
        fi
        
    - name: Try to build release with more info
      run: |
        echo "尝试构建release版本..."
        
        # 先尝试同步项目
        echo "同步项目..."
        ./gradlew buildEnvironment --stacktrace 2>&1 | tee sync.log || true
        
        # 构建release
        echo "构建release..."
        ./gradlew clean assembleRelease --stacktrace --warning-mode=all --info 2>&1 | tee release-build.log
        
        # 检查结果
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "✅ Release构建成功"
          echo "APK文件:"
          find . -name "*.apk" -type f | xargs ls -lh
        else
          echo "❌ Release构建失败"
          echo "错误摘要:"
          grep -i "error\|failed\|exception\|fail" release-build.log | head -20
          echo ""
          echo "最后200行日志:"
          tail -200 release-build.log
          exit 1
        fi
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@main
      with:
        name: build-logs
        path: |
          debug-build.log
          release-build.log
          sync.log
        retention-days: 7
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@main
      with:
        name: fantasytyx-bv-apk
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/apk/release/*.apk
        if-no-files-found: warn
        retention-days: 30